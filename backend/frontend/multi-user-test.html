<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-User Test - Phrase Weaver</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-info {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        .data-info {
            border-left-color: #ffc107;
            background: #fffef8;
        }
        .error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .create-btn {
            background: #28a745;
        }
        .create-btn:hover {
            background: #1e7e34;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üß™ Multi-User System Test</h1>
    <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</p>
    
    <div class="test-section user-info">
        <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
        <div id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button onclick="loadUserInfo()">–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
    </div>
    
    <div class="test-section">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="decks-count">-</div>
                <div class="stat-label">–ö–æ–ª–æ–¥—ã</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cards-count">-</div>
                <div class="stat-label">–ö–∞—Ä—Ç–æ—á–∫–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="user-id">-</div>
                <div class="stat-label">User ID</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="telegram-id">-</div>
                <div class="stat-label">Telegram ID</div>
            </div>
        </div>
        <button onclick="loadStats()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
    </div>
    
    <div class="test-section data-info">
        <h3>üìö –ú–æ–∏ –∫–æ–ª–æ–¥—ã</h3>
        <div id="decks-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button onclick="loadDecks()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª–æ–¥—ã</button>
        <button class="create-btn" onclick="createTestDeck()">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–ª–æ–¥—É</button>
    </div>
    
    <div class="test-section">
        <h3>üîß –¢–µ—Å—Ç–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <button onclick="testAuthentication()">–¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</button>
        <button onclick="testDataIsolation()">–¢–µ—Å—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö</button>
        <button onclick="clearUserData()">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h3>üìù –õ–æ–≥–∏</h3>
        <div id="logs"><pre>–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</pre></div>
        <button onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    </div>

    <script>
        const API_BASE_URL = 'https://pw-new.club';
        let authToken = null;
        let currentUser = null;
        const logs = [];
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            updateLogs();
        }
        
        function updateLogs() {
            document.getElementById('logs').innerHTML = 
                '<pre>' + logs.slice(-20).join('\n') + '</pre>';
        }
        
        function clearLogs() {
            logs.length = 0;
            updateLogs();
        }
        
        async function request(endpoint, method = 'GET', body = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const config = {
                method,
                headers
            };
            
            if (body) {
                config.body = JSON.stringify(body);
            }
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        async function authenticate() {
            try {
                addLog('–ù–∞—á–∏–Ω–∞–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é...');
                const response = await request('/api/auth/telegram/debug', 'POST');
                authToken = response.access_token;
                currentUser = response.user;
                addLog(`–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: ${currentUser.first_name} (ID: ${currentUser.id})`);
                return response;
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}`);
                throw error;
            }
        }
        
        async function loadUserInfo() {
            try {
                if (!authToken) {
                    await authenticate();
                }
                
                const userInfo = document.getElementById('user-info');
                userInfo.innerHTML = `
                    <strong>–ò–º—è:</strong> ${currentUser.first_name}<br>
                    <strong>Username:</strong> ${currentUser.username}<br>
                    <strong>ID:</strong> ${currentUser.id}<br>
                    <strong>Telegram ID:</strong> ${currentUser.telegram_id}<br>
                    <strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> ${new Date(currentUser.last_active).toLocaleString()}<br>
                    <strong>User Agent:</strong> ${navigator.userAgent}
                `;
                
                document.getElementById('user-id').textContent = currentUser.id;
                document.getElementById('telegram-id').textContent = currentUser.telegram_id;
                
                addLog('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            } catch (error) {
                document.getElementById('user-info').innerHTML = 
                    `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                addLog(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${error.message}`);
            }
        }
        
        async function loadDecks() {
            try {
                if (!authToken) {
                    await authenticate();
                }
                
                const decks = await request('/api/decks/');
                const decksList = document.getElementById('decks-list');
                
                if (decks.length === 0) {
                    decksList.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–ª–æ–¥. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>';
                } else {
                    decksList.innerHTML = decks.map(deck => `
                        <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px;">
                            <strong>${deck.name}</strong> (${deck.lang_from} ‚Üí ${deck.lang_to})<br>
                            <small>–ö–∞—Ä—Ç–æ—á–µ–∫: ${deck.cards_count} | ID: ${deck.id}</small>
                        </div>
                    `).join('');
                }
                
                document.getElementById('decks-count').textContent = decks.length;
                addLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ–ª–æ–¥: ${decks.length}`);
            } catch (error) {
                document.getElementById('decks-list').innerHTML = 
                    `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
                addLog(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–æ–¥: ${error.message}`);
            }
        }
        
        async function loadStats() {
            try {
                await loadUserInfo();
                await loadDecks();
                
                // –ü–æ–¥—Å—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫
                const decks = await request('/api/decks/');
                const totalCards = decks.reduce((sum, deck) => sum + deck.cards_count, 0);
                document.getElementById('cards-count').textContent = totalCards;
                
                addLog('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}`);
            }
        }
        
        async function createTestDeck() {
            try {
                if (!authToken) {
                    await authenticate();
                }
                
                const deckName = `–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–ª–æ–¥–∞ ${new Date().toLocaleTimeString()}`;
                const newDeck = await request('/api/decks/', 'POST', {
                    name: deckName,
                    description: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–ª–æ–¥–∞',
                    lang_from: 'en',
                    lang_to: 'ru'
                });
                
                addLog(`–°–æ–∑–¥–∞–Ω–∞ –∫–æ–ª–æ–¥–∞: ${newDeck.name} (ID: ${newDeck.id})`);
                await loadDecks();
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–ª–æ–¥—ã: ${error.message}`);
            }
        }
        
        async function testAuthentication() {
            try {
                addLog('=== –¢–ï–°–¢ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ===');
                
                // –û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω
                authToken = null;
                currentUser = null;
                addLog('–¢–æ–∫–µ–Ω –æ—á–∏—â–µ–Ω');
                
                // –ü—Ä–æ–±—É–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                await authenticate();
                addLog('‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
                const decks = await request('/api/decks/');
                addLog(`‚úÖ –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º: –Ω–∞–π–¥–µ–Ω–æ ${decks.length} –∫–æ–ª–æ–¥`);
                
                document.getElementById('test-results').innerHTML = 
                    '<div style="color: green;">‚úÖ –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–π–¥–µ–Ω</div>';
            } catch (error) {
                addLog(`‚ùå –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}`);
                document.getElementById('test-results').innerHTML = 
                    `<div style="color: red;">‚ùå –¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}</div>`;
            }
        }
        
        async function testDataIsolation() {
            try {
                addLog('=== –¢–ï–°–¢ –ò–ó–û–õ–Ø–¶–ò–ò –î–ê–ù–ù–´–• ===');
                
                if (!authToken) {
                    await authenticate();
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const myDecks = await request('/api/decks/');
                addLog(`–ú–æ–∏ –∫–æ–ª–æ–¥—ã: ${myDecks.length}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–æ–ª–æ–¥—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                const allBelongToMe = myDecks.every(deck => deck.user_id === currentUser.id);
                
                if (allBelongToMe) {
                    addLog('‚úÖ –í—Å–µ –∫–æ–ª–æ–¥—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');
                    document.getElementById('test-results').innerHTML = 
                        '<div style="color: green;">‚úÖ –¢–µ—Å—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–π–¥–µ–Ω</div>';
                } else {
                    addLog('‚ùå –ù–∞–π–¥–µ–Ω—ã –∫–æ–ª–æ–¥—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!');
                    document.getElementById('test-results').innerHTML = 
                        '<div style="color: red;">‚ùå –ù–∞—Ä—É—à–µ–Ω–∞ –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö!</div>';
                }
            } catch (error) {
                addLog(`‚ùå –¢–µ—Å—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}`);
                document.getElementById('test-results').innerHTML = 
                    `<div style="color: red;">‚ùå –¢–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω: ${error.message}</div>`;
            }
        }
        
        async function clearUserData() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–≤–æ–∏ –∫–æ–ª–æ–¥—ã?')) {
                try {
                    if (!authToken) {
                        await authenticate();
                    }
                    
                    const decks = await request('/api/decks/');
                    
                    for (const deck of decks) {
                        await request(`/api/decks/${deck.id}`, 'DELETE');
                        addLog(`–£–¥–∞–ª–µ–Ω–∞ –∫–æ–ª–æ–¥–∞: ${deck.name}`);
                    }
                    
                    addLog('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—á–∏—â–µ–Ω—ã');
                    await loadStats();
                } catch (error) {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
                }
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('DOMContentLoaded', async () => {
            addLog('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            addLog(`User Agent: ${navigator.userAgent}`);
            
            try {
                await loadStats();
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`);
            }
        });
    </script>
</body>
</html>